<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <script src="../../script/api.js"></script>
</head>
<body>
    <div id="regHtml">
    <form id="regsubfrom" onSubmit="return sub();">
                    <div class="mdmlogin">
                        <div class="zhanghao"><input type="number" name="mobile" id="mobile" placeholder="请输入手机号码"></div>
                        <div class="zhanghao"><input type="number" placeholder="短信码" style="width:6em" name="dxm" id="dxm" ><input type="button" data="0" value="发送短信码" class="loginbtn" id="jym" getYzmTime="0" YZM_EFFE="60" YZM_EFFE_USE="60" tapmode onClick="yzm_dxm.getDxm()"></div>
                        <div class="zhanghao" id="mima"><input type="password" name="password" id="password" placeholder="请输入6-20位密码"></div>
                        <div id="tjmdiv" style="display: none" class="zhanghao"><input type="text" name="tjm" id="tjm" placeholder="请输入推荐码"></div>
                        <input type="submit" value="立即注册" tapmode class="loginbtn">

                        <input type="hidden" name="web" id="web" value="">
                    <input type="hidden" name="webid" id="webid" value="">
                    <input type="hidden" name="webname" id="webname" value="">
                    <input type="hidden" name="unionid" id="unionid" value="">
                    <input type="hidden" name="avatar" id="avatar" value="">

                        <div class="iforgot" tapmode onClick="yiyouzhanghao()">已有账号？<a class="red">立即登录</a></div>

                        <div class="iforgot" id="webLoginTip"></div>
                    </div>
                    </form>
                </div>
</body>
<script>
var web='';

function yiyouzhanghao(){
	if(web==''){
		ddevent.openPage('user','login');
	}else{
		$('#mima,#tjmdiv').hide();
		$('#password').val("");
	}
}

function sub(){
    var mobile=$('#mobile').val();
    var dxm=$('#dxm').val();
    var password=$('#password').val();
    var web=$('#web').val();
    var webid=$('#webid').val();
    var webname=$('#webname').val();
	var avatar=$('#avatar').val();
	var unionid=$('#unionid').val();
	var tjm=$('#tjm').val();
    var url=createUrl('user',{'fun':'register','mobile':mobile,'ddpassword':password,'dxm':dxm,'web':web,'webid':webid,'unionid':unionid,'webname':webname,'avatar':avatar,'tjr':0,'tjm':tjm});
    getAjax(url,function(data){
        if(data.s==1){
            var jsfun = 'closeWin();';
            api.execScript({
                name: 'user_login',
                script: jsfun
            });
			set('DD_DDUSERID',data.r.id);
            set('DD_PASSWORD',data.r.ddpassword);
			updateUser(data.r);
			api.sendEvent({
                name: 'reStart'
            });
			if(web==''){
				var tip='注册成功';
			}else{
				var tip='绑定成功';
			}
            var ajpush = api.require('ajpush');
            var param = {alias:String(data.r.id),tags:[]};
            ajpush.bindAliasAndTags(param,function(ret) {
            });
            toastOpen(tip,1000,function(){
                closeWin();
            });
        }else{
            openAlert(data.r);
        }
    },'数据提交中');
	return false;
}

ready(function(){
    start();
},1);

function start(){
    web=get('web',1);
    var webid=get('webid',1);
    var webname=get('webname',1);
	var avatar=get('avatar',1);
	var unionid=get('unionid',1);

	var webTitle={'weixin':'微信','wx':'微信','tb':'淘宝','sina':'微博','qq':'QQ'};
	if(web!=''){
		$('#webLoginTip').html('使用'+webTitle[web]+'登录：'+webname);
	}
    if(web==''){
        setTitle('用户注册');
    }else{
        setTitle('完善注册');
		$('.loginbtn').val('绑定手机号');
    }
    $('#web').val(web);
    $('#webid').val(webid);
    $('#webname').val(webname);
	$('#avatar').val(avatar);
	$('#unionid').val(unionid);

	if(appInfo.reg_need_tjr>0){
	    $('#tjmdiv').show();
		if(appInfo.reg_need_tjr==1){
			$('#tjm').attr('placeholder','请输入推荐码（选填）');
		}else if(appInfo.reg_need_tjr==2){
			$('#tjm').attr('placeholder','请输入推荐码（必填）');
		}
	}
}
</script>
</html>
