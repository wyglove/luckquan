<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <script src="../../script/api.js"></script>
</head>
<body>
<div id="wrap" class="flex-wrap flex-vertical">
    <header style="background: #FFFFFF;color:#5f646d;border-bottom: 1px solid #f2f2f2">
            <div class="topbar">
                <div id="left" style="color:#5f646d;position:relative" tapmode="hover" class="egret-img fl" onClick="leftClick()">
                    <span class="iconfont">&#xe607;</span>
                </div>
                <div id="cha" style="color:#5f646d;position:relative; width:30px" tapmode="hover" class="egret-img fl" onClick="_closeWin()">
                    <span class="iconfont">&#xe622;</span>
                </div>
                <div id="right" style="color:#5f646d" class="egret-img fr" tapmode="hover" onclick="rightClick()">
                    <span class="iconfont">&#xe669;</span>
                </div>
                <div style="color:#5f646d" class="egret-img fr" tapmode="hover">
                </div>
                <div tapmode="hover" style="display: -webkit-flex;display: flex;-webkit-align-items: center;align-items: center;height: 100%;color:#333;justify-content: center;" class="egret-header-box"><div id="title" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;"><span style="text-indent:-100px">&nbsp;</span></div></div>
            </div>
        </header>
    <div id="main" class="flex-con">

    </div>
    <div id="footer"></div>
</div>
</body>
</html>
<script type="text/javascript">
    var browser,url,leftFun=0,frmArr=[],title,isTitleLock=false;

    ready(function(){
        api.addEventListener({
            name: 'reStart'
        }, function(ret, err) {
            uexWebView.close();
            openWebView(url);
        });
        var cha=api.pageParam.cha;
        if(cha==1){
            var child=document.getElementById("cha");
            if(child){
                child.innerHTML='';
            }
        }
        isTitleLock=api.pageParam.isTitleLock||false;
        var title=getGlobalData('title');
        if(title!=''){
            $api.dom('#title').innerHTML=title;
        }
        headerFuns('url');
        url=api.pageParam.url;
        openWebView(url);
    },0);

    function openWebView(url){
        if(url=='' || typeof url=='undefined'){
            alert('网址未定义');
        }
        var offset = $api.offset($api.dom('#main'));
        var intercept=['baiduboxapp://','pinduoduo://','http://lanjieapp','weixin://','https://uland','https://s.click.taobao.com'];
        var js='';
        var ua=navigator.userAgent;
        ua=ua.replace(/ duoduo:(\d+)? (\w+)?;/,'');
        ua+=' duoduo:'+get('DD_DDUSERID')+' '+get('DD_PASSWORD')+';';
        uexWebView.setUa(ua);
        uexWebView.open(url,{'x':offset.l,'y':offset.t,'w':offset.w,'h':offset.h},js,intercept,{
            'title':function(str){
              if (isTitleLock) {
                return false;
              }
                title=str;
                document.getElementById('title').innerHTML=title;
            },
            'url':function(str){
                url=str;
            },
            'intercept':function(data){
                if(data.indexOf('http://lanjieapp')==0){
                    data=data.replace(/http:\/\/lanjieapp\//,'');
                    data=data.split('/');
                    if(typeof data[1]!='undefined' && data[1].indexOf('?')==0){
                        var myURL = parseURL(data[1]);
                    }
                    if(data[0]=='close'){
                        if(typeof data[1]!='undefined' && data[1]!=''){
                            data=decodeURIComponent(data[1]);
                            openAlert(data,function(){
                                closeWin();
                            });
                        }else{
                            closeWin();
                        }
                    }else if(data[0]=='login'){
                        openPage('user','login');
                        setPageParam('from','url');
                    }else if(data[0]=='tblogin'){
                        var from=api.pageParam.from;
                        var webid=data[1];
                        var nick=data[2];
                        api.execScript({
                            name: 'user_'+from,
                            frameName: 'user_'+from+'_frm',
                            script: 'apilogin.login("tb","'+webid+'","'+nick+'","");'
                        });
                        closeWin();
                    }else if(data[0]=='fun'){
                        ddevent.fun(data[1]);
                    }
                }else if(data.indexOf('weixin://')==0){
                    openApp(data);
                    closeWin();
                }else if(data.indexOf('https://uland')==0 || data.indexOf('https://s.click.taobao.com')==0){
                    data=data.replace('https','taobao');
                    openApp(data);
                }
            }
        });
    }

    function _closeWin(){
        uexWebView.close();
        closeWin();
    }

    function leftClick(){
        if(frmArr.length>0){
            closeFrm(frmArr[frmArr.length-1])
        }else{
            uexWebView.back(function(){
                _closeWin();
            });
        }
    }

    function closeFrm(name){
        for(var i in frmArr){
            if(frmArr[i]==name){
                frmArr.splice(i,1);
            }
        }
        api.closeFrame({'name':name});
    }

    function rightClick(){
        //uexWebView.loadScript('location.reload()');
        frmArr.push('page_share_frm');
        share(title,url,'','','page_url');
    }
</script>
